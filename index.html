<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Detector</title>
    <style>
        #video {
            width: 100%;
            height: auto;
            max-width: 320px;
            max-height: 240px;
        }
    </style>
</head>
<body>
    <h1 id="status">No cat detected</h1>
    <select id="cameraSelect"></select>
    <video id="video" autoplay playsinline muted></video>
    <textarea id="predictions" rows="5" cols="50" readonly></textarea>
    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const predictionsBox = document.getElementById('predictions');
        const cameraSelect = document.getElementById('cameraSelect');
        const modelUrl = 'mobilenet_v2.tflite'; // Make sure this path is correct

        let currentStream;

        // Request access to the camera and list available cameras
        async function getCameras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            cameraSelect.innerHTML = '';
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${index + 1}`;
                cameraSelect.appendChild(option);
            });

            if (videoDevices.length > 0) {
                startVideo(videoDevices[0].deviceId);
            }
        }

        async function startVideo(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { deviceId: { exact: deviceId } }
            });
            currentStream = stream;
            video.srcObject = stream;
            video.play();
        }

        cameraSelect.onchange = () => {
            startVideo(cameraSelect.value);
        };

        // Initialize the web worker
        const worker = new Worker('tfjs_worker.js');

        worker.onmessage = function(event) {
            if (typeof event.data === 'string') {
                console.log('Message from worker:', event.data);
                if (event.data === 'Model loaded successfully') {
                    startProcessing();
                } else {
                    console.error(event.data);
                }
            } else {
                const { predictions } = event.data;
                const top3 = predictions
                    .map((value, index) => ({ value, index }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 3);

                console.log('Top 3 predictions: ', top3);

                // Define cat classes based on ImageNet class indices
                const catClasses = [281, 282, 283, 284, 285]; // Including additional cat classes

                const catDetected = top3.some(prediction => catClasses.includes(prediction.index));
                status.innerText = catDetected ? 'Cat detected!' : 'No cat detected';

                predictionsBox.value = top3.map(prediction => 
                    `Class: ${prediction.index}, Confidence: ${(prediction.value * 100).toFixed(2)}%`
                ).join('\n');
            }
        };

        worker.postMessage({ modelUrl });

        function startProcessing() {
            // Process video frames
            const processFrame = async () => {
                const canvas = document.createElement('canvas');
                canvas.width = 224;
                canvas.height = 224;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, 224, 224);
                const imageData = context.getImageData(0, 0, 224, 224).data;
                
                worker.postMessage({ imageData });

                requestAnimationFrame(processFrame);
            };
            processFrame();
        }

        getCameras();
    </script>
</body>
</html>
